<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event Upload (Drive Only)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css.css">
  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Upload files for the Event</h1>

      <div class="btns" style="margin-bottom:12px">
        <button id="signInBtn" type="button" class="ghost">Sign in with Google</button>
        <button id="signOutBtn" type="button" class="ghost" style="display:none">Sign out</button>
      </div>

      <form id="eventForm" novalidate>
        <label for="eventName">Event Name</label>
        <input id="eventName" name="EventName" type="text" placeholder="e.g., Freshers Day 2025" required />

        <div class="two-col">
          <div>
            <label>File Option 1</label>
            <div id="dz1" class="dz">
              <input type="file" id="file1" hidden />
              <div id="f1info">No file selected</div>
              <div class="file-meta" id="f1meta">Click or drag & drop</div>
              <img id="f1preview" class="preview" />
              <video id="f1video" class="preview" controls></video>
            </div>
          </div>
          <div>
            <label>File Option 2</label>
            <div id="dz2" class="dz">
              <input type="file" id="file2" hidden />
              <div id="f2info">No file selected</div>
              <div class="file-meta" id="f2meta">Click or drag & drop</div>
              <img id="f2preview" class="preview" />
              <video id="f2video" class="preview" controls></video>
            </div>
          </div>
        </div>

        <div class="btns">
          <button type="submit" class="primary" id="submitBtn">Submit</button>
          <button type="button" class="ghost" id="resetBtn">Reset</button>
        </div>
        <div id="msg" class="msg"></div>
      </form>
    </div>
  </div>

  <div class="note">
    ‚è≥ Large uploads (200MB+) are supported via Google Drive‚Äôs resumable upload.<br>
    Please <u>stay on this page</u> until you see the success message.
  </div>

  <script>
    // ---------------------
    // üîß CONFIG
    // ---------------------
    const CLIENT_ID = "945133456425-s5t42pn5eer58g8qnfnk9lvrbsjn2o3c.apps.googleusercontent.com";
    const API_KEY   = "AIzaSyBNvQCHMzcYYtuoK7qk3twIjiRFPpB-iL0"; 
    const ROOT_FOLDER_ID = ""; // optional: put a Drive folder ID here

    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    // UI shortcuts
    const $ = id => document.getElementById(id);
    const form=$("eventForm"), msg=$("msg"), submitBtn=$("submitBtn"), resetBtn=$("resetBtn");
    const signInBtn=$("signInBtn"), signOutBtn=$("signOutBtn");
    const inputs=[
      {dz:$("dz1"),input:$("file1"),info:$("f1info"),meta:$("f1meta"),img:$("f1preview"),vid:$("f1video")},
      {dz:$("dz2"),input:$("file2"),info:$("f2info"),meta:$("f2meta"),img:$("f2preview"),vid:$("f2video")}
    ];

    let tokenClient;

    window.addEventListener("load", () => {
      const wait=setInterval(()=>{
        if(window.gapi && window.google){
          clearInterval(wait);
          initClients();
        }
      },100);
    });

    async function initClients() {
      await new Promise(resolve => {
        gapi.load('client', async () => {
          await gapi.client.init({ apiKey: API_KEY });
          resolve();
        });
      });

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: () => { updateAuthUI(); }
      });

      signInBtn.addEventListener("click", ensureSignedIn);
      signOutBtn.addEventListener("click", signOut);
      updateAuthUI();
    }

    function updateAuthUI() {
      const token = gapi.client.getToken();
      const signedIn = !!token;
      signInBtn.style.display = signedIn ? "none" : "inline-flex";
      signOutBtn.style.display = signedIn ? "inline-flex" : "none";
    }

    function ensureSignedIn() {
      if (!gapi.client.getToken()) {
        tokenClient.requestAccessToken({ prompt:"consent" });
      }
    }

    function signOut() {
      const token = gapi.client.getToken();
      if(token){
        google.accounts.oauth2.revoke(token.access_token, ()=> {
          gapi.client.setToken("");
          updateAuthUI();
          msg.className="msg"; msg.textContent="Signed out.";
        });
      }
    }

    // drag-drop previews
    inputs.forEach(({dz,input,info,meta,img,vid})=>{
      dz.addEventListener("click",()=>input.click());
      ["dragenter","dragover"].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add("drag");}));
      ["dragleave","drop"].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove("drag");}));
      dz.addEventListener("drop",e=>{
        if(e.dataTransfer.files?.length){ input.files=e.dataTransfer.files; input.dispatchEvent(new Event("change")); }
      });
      input.addEventListener("change",()=>{
        img.style.display=vid.style.display="none"; info.textContent="No file selected"; meta.textContent="Click or drag & drop";
        if(input.files.length){
          const f=input.files[0];
          info.textContent=f.name;
          meta.textContent=(f.size/1024/1024).toFixed(2)+" MB ‚Ä¢ "+(f.type||"unknown");
          const url=URL.createObjectURL(f);
          if(f.type.startsWith("image/")){ img.src=url; img.style.display="block"; }
          else if(f.type.startsWith("video/")){ vid.src=url; vid.style.display="block"; }
        }
      });
    });

    // Drive: resumable upload
    async function uploadToDrive(file, folderId, onProgress) {
      const token = gapi.client.getToken()?.access_token;
      if(!token) throw new Error("Not signed in.");

      // 1) initiate
      const initRes = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable", {
        method:"POST",
        headers:{
          "Authorization":"Bearer "+token,
          "Content-Type":"application/json; charset=UTF-8",
          "X-Upload-Content-Type":file.type||"application/octet-stream",
          "X-Upload-Content-Length":String(file.size)
        },
        body: JSON.stringify({
          name: new Date().toISOString().replace(/[:.]/g,"-")+"__"+file.name,
          parents: folderId ? [folderId] : undefined
        })
      });
      if(!initRes.ok) throw new Error("Failed to init upload.");
      const uploadUrl=initRes.headers.get("Location");

      // 2) PUT the file
      return await new Promise((resolve,reject)=>{
        const xhr=new XMLHttpRequest();
        xhr.upload.onprogress=(e)=>{
          if(e.lengthComputable && typeof onProgress==="function"){
            onProgress(Math.round((e.loaded/e.total)*100));
          }
        };
        xhr.onreadystatechange=()=>{
          if(xhr.readyState===4){
            if(xhr.status===200 || xhr.status===201){
              try{ resolve(JSON.parse(xhr.responseText)); }
              catch{ resolve({id:null}); }
            } else reject(new Error("Upload failed: "+xhr.status));
          }
        };
        xhr.open("PUT",uploadUrl,true);
        xhr.setRequestHeader("Authorization","Bearer "+token);
        xhr.setRequestHeader("Content-Type",file.type||"application/octet-stream");
        xhr.send(file);
      });
    }

    // Submit
    form.addEventListener("submit",async e=>{
      e.preventDefault();
      submitBtn.disabled=true;
      msg.className="msg"; msg.textContent="Starting upload‚Ä¶";
      try{
        if(!gapi.client.getToken()){
          await new Promise(res=>{
            tokenClient.callback=()=>res();
            tokenClient.requestAccessToken({prompt:"consent"});
          });
        }
        const eventName=$("eventName").value.trim();
        if(!eventName) throw new Error("Enter Event Name.");
        const selected=inputs.map(({input})=>input.files[0]).filter(Boolean);
        if(selected.length===0) throw new Error("No files selected.");

        const results=[];
        for(const file of selected){
          msg.textContent=`Uploading ${file.name} (0%)‚Ä¶`;
          const res=await uploadToDrive(file,ROOT_FOLDER_ID,(pct)=>{
            msg.textContent=`Uploading ${file.name} (${pct}%)‚Ä¶`;
          });
          results.push(`https://drive.google.com/file/d/${res.id}/view`);
        }
        msg.className="msg ok";
        msg.textContent="‚úÖ Uploaded!\n"+results.join("\n");
        form.reset();
        inputs.forEach(({input})=>input.dispatchEvent(new Event("change")));
      }catch(err){
        console.error(err);
        msg.className="msg err"; msg.textContent=err.message;
      }finally{
        submitBtn.disabled=false;
      }
    });

    resetBtn.addEventListener("click",()=>{
      form.reset();
      inputs.forEach(({input})=>input.dispatchEvent(new Event("change")));
      msg.style.display="none";
    });
  </script>
</body>
</html>
